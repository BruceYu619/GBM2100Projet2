/* ========================================
 *
 * Copyright YOUR COMPANY, THE YEAR
 * All Rights Reserved
 * UNPUBLISHED, LICENSED SOFTWARE.
 *
 * CONFIDENTIAL AND PROPRIETARY INFORMATION
 * WHICH IS THE PROPERTY OF your company.
 *
 * ========================================
*/
#include "project.h"
#include <arm_math.h>
#include <core_cm4.h>
#include "FreeRTOS.h"
#include "task.h"
#include <stdio.h>
# include <stdlib.h>


#define TEST_LENGTH_SAMPLES  250
#define BLOCK_SIZE 250 
#define NUM_TAPS 253


static float32_t firStateF32[BLOCK_SIZE + NUM_TAPS -1];
const float32_t firCoeffs32[NUM_TAPS]= {
  -0.00607483793096646, -0.0024371287606626195,-0.0027781905680449846,-0.003033314895885208,-0.003173529940827935, -0.0031718611490409022,
  -0.0030059549911707804,-0.0026582996982429997,-0.0021206768776838745,-0.0013930798983935906,-0.0004846804998994125,
  0.0005849933602285507,0.0017862009128820602,0.0030810159261001435,0.004423969560030488,0.005763782521862455,
  0.007045918758019425, 0.008215415960009582, 0.009219483087725007,  0.010010534279067623,0.010548693224964979,
  0.01080440385291239,0.010760782668331208,0.010414993506442368,0.009778471481675913,0.008876937657684842,
  0.007749689142662804,0.006447897380983346,0.0050320446080451145,0.003568730794722048,0.002127071855917517,
  0.0007753090520778832,-0.0004226650476138258,-0.0014111406052432548,-0.002146096239735076,-0.0025978219588661013,-0.0027527697559420077, -0.0026145226007014354,
  -0.0022036900977844007,-0.0015569645721613154,-0.0007249669258958543,0.0002310350951244312,0.0012427956789621325,
  0.002238729459804291,0.0031481529420859314,0.0039055522429964702,0.004454726008316521,0.004752719601171644,
  0.004773255715181325,0.004508534227584674,0.003970048860958966,0.0031874472285343416,0.002205937583394404,0.0010837345196781833,
  -0.00010923350169881752, -0.0012952679534577597, -0.0023945429785403325, -0.003332332823935724, -0.004045296772034923,
  -0.004485408593398273,-0.004614917522743556,-0.00441217984966828,-0.003885995000375412,-0.0030808389741815213,
  -0.0020141623274676783,-0.0007782377925754881,0.0005616645873690594,0.0019129838577996584,0.0031838361359370257,0.004284423529885197,0.00513506262382178,0.005667910542150519,0.005834744828386903,0.0056110733352465626,0.004997419504720941,0.004019717734892768, 0.002729912014942273, 0.0012030793358242167, -0.0004668425921367343,
  -0.0021727310678983564, -0.0038007346052471524, -0.005237258715165205, -0.006375914005110297, -0.007125386753041694, -0.007416504850484698, -0.0072075224337611096, -0.006487740253034502, -0.005279828969058826, -0.0036400447991626252, -0.0016564184687979369, 0.000555390130751074, 0.0028584504161569117,  0.005102324883996254, 0.00713155208693635,0.008795179993414748, 0.009956854266028966, 0.010504460859160588, 0.010358753199561576, 0.009480345137566713, 0.007874416721930302, 0.005593132697524436, 0.0027357401166407105, -0.0005542361106088803, -0.004094388228848386, -0.0076711614792899655, -0.011050056531832247,  -0.013987921185448797,
  -0.01624576416175618,  -0.01760171190974374,  -0.017863462725779947, -0.01687987593831393,  -0.014551309160842324,  -0.010838242190593624,  -0.005765677619153919, 0.0005760356953147042, 0.008032942259665101,  0.016391592351990718,  0.02538714309010219,  0.03471375565173058, 0.044039170151085945,  0.05302025437713948,  0.06131721136404679,  0.06860640657800217,  0.07460132529989161,  0.0790649476574384,  0.08181928122930736,  0.08274552238985647, 0.08181928122930736,
  0.0790649476574384,  0.07460132529989161,  0.06860640657800217,  0.06131721136404679,  0.05302025437713948,  0.044039170151085945,  0.03471375565173058,  0.02538714309010219,  0.016391592351990718,  0.008032942259665101,  0.0005760356953147042,  -0.005765677619153919,  -0.010838242190593624,  -0.014551309160842324,  -0.01687987593831393,  -0.017863462725779947,  -0.01760171190974374, -0.01624576416175618, -0.013987921185448797, -0.011050056531832247,
  -0.0076711614792899655,  -0.004094388228848386,  -0.0005542361106088803,  0.0027357401166407105,  0.005593132697524436,  0.007874416721930302,  0.009480345137566713,  0.010358753199561576,  0.010504460859160588,  0.009956854266028966,  0.008795179993414748,  0.00713155208693635,  0.005102324883996254, 0.0028584504161569117, 0.000555390130751074, -0.0016564184687979369,  -0.0036400447991626252,  -0.005279828969058826,  -0.006487740253034502, -0.0072075224337611096, -0.007416504850484698,  -0.007125386753041694, -0.006375914005110297, -0.005237258715165205, -0.0038007346052471524, -0.0021727310678983564, -0.0004668425921367343, 0.0012030793358242167, 0.002729912014942273, 0.004019717734892768, 0.004997419504720941,  0.0056110733352465626, 0.005834744828386903,
  0.005667910542150519,  0.00513506262382178,  0.004284423529885197,  0.0031838361359370257,  0.0019129838577996584,  0.0005616645873690594,  -0.0007782377925754881,  -0.0020141623274676783,  -0.0030808389741815213,  -0.003885995000375412,  -0.00441217984966828,  -0.004614917522743556,  -0.004485408593398273,  -0.004045296772034923, -0.003332332823935724,  -0.0023945429785403325,  -0.0012952679534577597,  -0.00010923350169881752,  0.0010837345196781833,  0.002205937583394404,  0.0031874472285343416,  0.003970048860958966,  0.004508534227584674,  0.004773255715181325,  0.004752719601171644,  0.004454726008316521,  0.0039055522429964702,  0.0031481529420859314,  0.002238729459804291, 0.0012427956789621325, 0.0002310350951244312,-0.0007249669258958543, -0.0015569645721613154, -0.0022036900977844007,
  -0.0026145226007014354,  -0.0027527697559420077,  -0.0025978219588661013,  -0.002146096239735076, -0.0014111406052432548, -0.0004226650476138258,  0.0007753090520778832, 0.002127071855917517,  0.003568730794722048,  0.0050320446080451145, 0.006447897380983346, 0.007749689142662804, 0.008876937657684842,  0.009778471481675913,
  0.010414993506442368,  0.010760782668331208,  0.01080440385291239,  0.010548693224964979,
  0.010010534279067623,  0.009219483087725007,  0.008215415960009582,  0.007045918758019425,  0.005763782521862455,  0.004423969560030488,  0.0030810159261001435,  0.0017862009128820602, 0.0005849933602285507, -0.0004846804998994125,
  -0.0013930798983935906,  -0.0021206768776838745, -0.0026582996982429997,  -0.0030059549911707804,  -0.0031718611490409022, -0.003173529940827935, -0.003033314895885208,-0.0027781905680449846,-0.0024371287606626195, -0.00607483793096646
};

extern float32_t testInput_f32_1kHz_15kHz[TEST_LENGTH_SAMPLES];
extern float32_t refOutput[TEST_LENGTH_SAMPLES];



uint32_t blockSize = BLOCK_SIZE;
uint32_t numBlocks = TEST_LENGTH_SAMPLES/BLOCK_SIZE;
arm_fir_instance_f32 S; 
volatile float R =0;
volatile float SpO2 =0;

volatile int NbreMax =0;
volatile int flag =0;
volatile int NbreSec =0;
volatile float Circulaire[60] = {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0};

float BPM(float* maximum){
    float BPM =0;
		if(flag ==1){
			flag =0;
			float moyenneMax =0;
			arm_mean_f32(maximum, 30, &moyenneMax);
			int Vrai =0;
				for(int i =0; i> 30;i++){
					if(maximum[i] > 0.5*moyenneMax)
						Vrai = Vrai + 1;
				}
			 BPM = 60*Vrai/10;
		}	
		if(flag ==2){
			flag =0;
			float moyenneMax =0;
			arm_mean_f32(maximum, 30, &moyenneMax);
			int Vrai =0;
				for(int i =30; i> 60;i++){
					if(maximum[i] > 0.5*moyenneMax)
						Vrai = Vrai + 1;
				}
			BPM = Vrai*6;
		}
	return(BPM);
}



float Saturation(float* dataIR, float* dataRed){
	NbreSec = NbreSec +1;

// Trouver les composantes DC
	float DCIR =0;
	float DCRED =0;
	arm_mean_f32(dataIR, BLOCK_SIZE,&DCIR);
	arm_mean_f32(dataRed, BLOCK_SIZE, &DCRED);

// Filtrage 
	float IrFiltre[250];
    float RedFiltre[250];
	arm_fir_init_f32(&S, NUM_TAPS, (float32_t *)&firCoeffs32[0], &firStateF32[0], blockSize);
    arm_fir_f32(&S, dataIR, IrFiltre,BLOCK_SIZE);
    arm_fir_f32(&S, dataRed, RedFiltre,BLOCK_SIZE);

// Trouver les composantes AC
	float maxIR =0;
	float maxRed =0;
	float minIR =0;
	float minRed =0;	
	uint32_t position =0;

	arm_max_f32(IrFiltre, BLOCK_SIZE, &maxIR, &position);
	arm_max_f32(RedFiltre, BLOCK_SIZE, &maxRed, &position);
	arm_min_f32(IrFiltre, BLOCK_SIZE, &minIR, &position);
	arm_min_f32(RedFiltre, BLOCK_SIZE, &minRed, &position);

	float ACIr = maxIR - minIR;
	float ACRed = maxRed - minRed;

// Trouver la saturation dans l'intervale:
	 R = (ACRed/DCRED)/(ACIr/DCIR);
	 SpO2 = -16.67*(R*R) + 8.33*R + 100;

// Trouver les maximums dans l'intervale
	for(int i=1; i>BLOCK_SIZE-1; i++){
		if((IrFiltre[i] > IrFiltre[i-1]) && (IrFiltre[i] > IrFiltre[i+1]) && (IrFiltre[i] >0)){
			Circulaire[NbreMax] = IrFiltre[i];
			NbreMax =NbreMax +1;
		}
	}

// Allumer les flags
	if(NbreSec % 20 == 0){
		NbreMax = 0;
		flag = 2;
	}
	if((NbreSec %10 == 0) && (NbreSec %20 !=0)){
		NbreMax = 30;
		flag = 1;
	}
    return(SpO2);
}
volatile bool Index = false;

// Valeurs a enlevees
float* maximum;
float* dataIR;
float* dataRed;

int main(void)
{
    SystemInit();
//    SystemCoreClockUpdate();
  
    __enable_irq(); /* Enable global interrupts. */

    /* Place your initialization/startup code here (e.g. MyInst_Start()) */

    for(;;)
    {
        if(Index == true){
            Index = false;
            float SpO2 = Saturation(dataIR, dataRed);
        }
        if(NbreSec %10 == 0){           
            float bpm = BPM(maximum);
        }
        /* Place your application code here. */
        

    }
}




